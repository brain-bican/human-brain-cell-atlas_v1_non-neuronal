{% extends "page.html" %}

{% set range = result.range %}
{% set table = result.table %}
{% set columns = result.columns %}
{% set rows = result.rows %}

{% block styles %}
<link href="/api/browser/human-brain-cell-atlas_v1_non-neuronal/static/main.css" rel="stylesheet">
{% endblock %}

{% block content %}
<h1>{{ table.name }}</h1>

<div id="portal" style="width: 100%; min-width: 400px; left: auto; right: auto"></div>

<p class="range">Rows {{ range.start }}-{{ range.end }} of {{ range.total }}</p>
<table class="table">
  <thead>
    <tr>
      {% for column in columns %}
      <th>{{ column.name }}</th>
      {% endfor %}
    </tr>
  </thead>
  <tbody>
    {% for row in rows %}
    <tr>
      {% for column, cell in row.cells|items %}
      <td>{{ cell.text }}</td>
      {% endfor %}
    </tr>
    {% endfor %}
  </tbody>
</table>
{% endblock %}

{% block scripts %}
<script async>
  window.rltbl = {};
  window.rltbl.site = {{site | tojson}};
  window.rltbl.result = {{result | tojson}};

  // Example: Use an autocomplete dropdown for 'penguin.island' column.
  const table = {{result.table.name | tojson}};
  var columns = {{result.columns | tojson}};
  for (var i = 0; i < columns.length; i++) {
    var kind = "text";
    if (table === "annotation") {
      const col = columns[i].name;
      if (col === "cell_ontology_term") {
        kind = "dropdown";
      } else if (col === "review") {
        kind = "image";
      }
    }
    window.rltbl.result.columns[i].kind = kind;
  }

  const fetchSuggestions = async function (inputValue) {
    const response = await fetch(
      `https://cellular-semantics.sanger.ac.uk/demo/api/suggest?query=${inputValue}&filter=Cell`
    );
    const data = await response.json();
    return data.response.docs;
  };

  const transformData = (data) => {
    return data.map((item) => ({
      value: item.label_autosuggest_e,
      label: item.label_autosuggest_e + "     (" + item.obo_id[0] + ")",
      id: item.obo_id[0]
    }));
  };

  window.rltbl.loadOptions = async function (row, column, inputValue, callback) {
    const suggestions = await fetchSuggestions(inputValue);
    const options = transformData(suggestions);
    callback(options);
  };

  window.rltbl.onCellsEdited = (newValues) => {
    // console.log("Outer onCellEdited", newValues);
    var addedValues = [];
    try {
      if (window.rltbl.result.table.name === "annotation") {
        for (var i = 0; i < newValues.length; i++) {
          var newValue = newValues[i];
          console.log("newValue", newValue);
          var col = newValue.location[0];
          var row = newValue.location[1];
          if (columns[col].name === "cell_ontology_term") {
            addedValues.push({
              location: [col - 1, row],
              value: {kind: "text", data: newValue.value.data.entry.id}
            });
          }
        }
      }
    } catch (e) { }
    return newValues.concat(addedValues);
  };
</script>
<script defer="defer" src="/api/browser/human-brain-cell-atlas_v1_non-neuronal/static/main.js"></script>
{% endblock %}